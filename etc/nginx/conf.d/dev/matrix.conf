map $http_origin $matrix_cors_origin {
    default "";
    "~^https?://(www\.)?(nutra\.tk|dev\.nutra\.tk|matrix\.nutra\.tk)$" "$http_origin";
}

server {
    server_name matrix.nutra.tk chat.nutra.tk;
    listen 443 ssl;
    listen [::]:443 ssl;
    listen 443 quic;
    listen [::]:443 quic;
    http2 on;
    http3 on;
    add_header Alt-Svc 'h3=":443"; ma=86400' always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # SSL / HTTPS
    ssl_certificate /etc/letsencrypt/live/dev.nutra.tk/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/dev.nutra.tk/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    ssl_trusted_certificate /etc/ssl/private/ca-certs.pem;

    add_header X-Debug-Server "Matrix";
    client_max_body_size 50m;
    client_body_buffer_size 128k;

    location / {
        # Service: Matrix Chat | https://matrix.nutra.tk
        proxy_pass http://127.0.0.1:8008;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Forwarded-For $remote_addr;

        # Hide upstream CORS headers to prevent duplication (Conduit sends *, we need specific for Creds)
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Expose-Headers;
        
        # Hide upstream CSP to prevent conflict with our global CSP ("none" error)
        proxy_hide_header Content-Security-Policy;

        # CORS Headers (Simplified with Map)
        add_header 'Access-Control-Allow-Origin' "$matrix_cors_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$matrix_cors_origin";
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # Timeouts for Matrix (especially for federation and initial sync)
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_connect_timeout 600s;
    }

    location /favicon.ico {
        alias /var/www/favicon.gif;
    }
}

# Open matrix chat on 8448
server {
    listen 8448 ssl default_server;
    listen [::]:8448 ssl default_server;
    listen 8448 quic default_server;
    listen [::]:8448 quic default_server;
    http2 on;
    http3 on;
    add_header Alt-Svc 'h3=":8448"; ma=86400' always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    ssl_trusted_certificate /etc/ssl/private/ca-certs.pem;
    # NOTE: this is for the base server, but also matrix
    server_name dev.nutra.tk;

    location / {
        proxy_pass http://127.0.0.1:8008;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Forwarded-For $remote_addr;

        # Timeouts for Matrix
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_connect_timeout 600s;
    }

    # HTTPS / SSL
    ssl_certificate /etc/letsencrypt/live/dev.nutra.tk/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/dev.nutra.tk/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}
