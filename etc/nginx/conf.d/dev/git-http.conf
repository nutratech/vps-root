server {
    server_name git.nutra.tk;

    # Listening Ports
    listen 443 quic;
    listen [::]:443 quic;
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    http3 on;


    # Block/drop bots
    if ($bad_bot) {
        return 444;
    }
    include /etc/nginx/conf.d/blocked_ips.conf;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/dev.nutra.tk/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/dev.nutra.tk/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    ssl_trusted_certificate /etc/ssl/private/ca-certs.pem;

    # Headers
    add_header Alt-Svc 'h3=":443"; ma=86400' always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Common Git Root
    set $git_root /srv/git;

    # ----------------------------------------------------------------------
    # Site Map
    # ----------------------------------------------------------------------
    location = /services {
        alias /srv/git/services.html;
        default_type text/html;
    }

    # ----------------------------------------------------------------------
    # Version 1: Original Gitweb (Basic)
    # ----------------------------------------------------------------------

    # Static assets for standard gitweb
    location ^~ /v1/static/ {
        alias /usr/share/gitweb/static/;
    }

    # Git Smart HTTP Backend (v1)
    location ~ ^/v1/git(/.*)$ {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /usr/lib/git-core/git-http-backend;
        fastcgi_param GIT_PROJECT_ROOT $git_root;
        fastcgi_param GIT_HTTP_EXPORT_ALL "1";
        fastcgi_param PATH_INFO $1;
        fastcgi_param REMOTE_USER $remote_user;
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
    }

    # Gitweb UI (v1)
    location ~ ^/v1(/.*)?$ {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /usr/share/gitweb/gitweb.cgi;
        fastcgi_param PATH_INFO $1;
        fastcgi_param GITWEB_CONFIG /etc/gitweb.conf;
        fastcgi_param GITWEB_VERSION "v1";
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
    }

    # ----------------------------------------------------------------------
    # Version 2: Styled Frontend (Theme, Static)
    # ----------------------------------------------------------------------

    # Custom Theme/Assets Aliases for v2
    location ^~ /v2/theme/ {
        alias /srv/git/theme/;
    }
    location ^~ /v2/assets/ {
        alias /srv/git/assets/;
    }
    location ^~ /v2/static/ {
        alias /usr/share/gitweb/static/;
    }

    # Git Smart HTTP Backend (v2)
    location ~ ^/v2/git(/.*)$ {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /usr/lib/git-core/git-http-backend;
        fastcgi_param GIT_PROJECT_ROOT $git_root;
        fastcgi_param GIT_HTTP_EXPORT_ALL "1";
        fastcgi_param PATH_INFO $1;
        fastcgi_param REMOTE_USER $remote_user;
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
    }

    # Gitweb UI (v2)
    location ~ ^/v2(/.*)?$ {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /usr/share/gitweb/gitweb.cgi;
        fastcgi_param PATH_INFO $1;
        fastcgi_param GITWEB_CONFIG /etc/gitweb.conf;
        fastcgi_param GITWEB_VERSION "v2";
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
    }

    # ----------------------------------------------------------------------
    # /v3 redirect -> root
    # ----------------------------------------------------------------------
    location = /v3 {
        return 302 /;
    }
    location = /v3/ {
        return 302 /;
    }

    # ----------------------------------------------------------------------
    # Version 3: Gitea (Full Server with Backend, Main)
    # ----------------------------------------------------------------------

    location / {
        proxy_pass http://localhost:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ----------------------------------------------------------------------
    # Clean Git Remotes (Root Level .git)
    # ----------------------------------------------------------------------
    # Catches /user/repo.git and /user/repo.git/info/refs
    # Place this AFTER v1/v2 regex blocks so it doesn't interfere with them
    location ~ \.git(/|$) {

        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Recommended for Git Pushes
        client_max_body_size 512M;
    }
}

# HTTP to HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name git.nutra.tk;

    return 301 https://$host$request_uri;
}
